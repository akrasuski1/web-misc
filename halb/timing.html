<html>
<header>
 <script src="default.js"></script>
 <script src="WaveDrom.js"></script>
</header>
<body onload="WaveDrom.ProcessAll()">

<h2>HALB timings</h2>



<script type="WaveDrom">
{ 
  "signal" : [
    { "name": "PHASE", "wave": "==..==..==..", "node": ".A", "data": "- 1 - 2 - 1" },
    { "name": "PCw",   "wave": "01..0....1..", "data": "" },
    { "name": "PC",    "wave": "=x=......x=.", "data": "11 12 13" },
    { "name": "ROMdat","wave": "=x.=.....x.=", "node": "...B", "data": " ROM[12]" },
    { "name": "PC+1",  "wave": "=x.=.....x.=", "data": "12 13 14" },
    { "name": "NXw",   "wave": "0....1..0...", "data": "" },
    { "name": "NX",    "wave": "=....x=.....", "data": "12 13" },
  
  ],
  "edge": [
  //  "A~B tOP"
  ],
  //"head": { text: "[0012]: XOR A, H ; A = 2, H = 4" },
  "head": { text: "Typical PC and opcode timing" },
  "config": { "hscale": 1 }
}

</script>

 <script type="WaveDrom">

 { 
  "signal" : [
    { "name": "PHASE", "wave": "==..==..==", "data": "- 1 - 2 - 1" },
    { "name": "ROMdat","wave": "=x=......x", "data": ["", "STORE [H:L], B", ""] },
    { "name": "ABUS",  "wave": "x..=.....x", "data": ["H:L"] },
    { "name": "DBUS",  "wave": "x..=.....x", "data": ["B"] },
    { "name": "RAM WE","wave": "0....1..0.", "data": [] },
  
  ],
  "edge": [
    
  ],
  //"head": { text: "[0012]: XOR A, H ; A = 2, H = 4" },
  "head": { text: "RAM write cycle" },
  "config": { "hscale": 1 }
}
</script>
 <script type="WaveDrom">
 
 { 
  "signal" : [
    { "name": "PHASE", "wave": "==...==..==", "data": "- 1 - 2 - 1" },
    { "name": "ROMdat","wave": "=x=.......x", "data": ["", "LOAD B, [H:L]", ""] },
    { "name": "ABUS",  "wave": "x..=......x", "data": ["H:L"] },
    { "name": "DBUS",  "wave": "x...=.....x", "data": ["DATA"] },
    { "name": "RAM OE","wave": "0..1......0", "data": [] },
    { "name": "REGB W","wave": "0.....1..0.", "data": [] },
  
  ],
  "edge": [
    
  ],
  //"head": { text: "[0012]: XOR A, H ; A = 2, H = 4" },
  "head": { text: "RAM read cycle" },
  "config": { "hscale": 1 }
}
 </script>
 <script type="WaveDrom">
 
 { 
  "signal" : [
    { "name": "PHASE", "wave": "==....=.=..==", "data": "- 1 - 2 - 1" },
    { "name": "ROMdat","wave": "=x=.........x", "data": ["", "XOR A, B", ""] },
    { "name": "DBUS",  "wave": "x..=....=...x", "data": ["B", "T=A^B"] },
    { "name": "ALU",   "wave": "x...=...x...x", "data": ["A^B"] },
    { "name": "REGT W","wave": "0..1...0.....", "data": [] },
    { "name": "T",     "wave": "x....=......x", "data": ["A^B"] },
    { "name": "REGA W","wave": "0.......1..0.", "data": [] },
    { "name": "A",     "wave": "=.......x=...", "data": ["A", "A^B"] },
  
  ],
  "edge": [
    
  ],
  //"head": { text: "[0012]: XOR A, H ; A = 2, H = 4" },
  "head": { text: "ALU operation" },
  "config": { "hscale": 1 }
}
 </script>

 
 <script type="WaveDrom">
 
 { 
  "signal" : [
    { "name": "PHASE",   "wave": "==...==.==...==.==.", "data": "- 1 - 2 - 1 - 2 - 1" },
    { "name": "ROMdat",  "wave": "=x.=.....x.=.....x.", "data": ["", "LPM A, [H:L]", "ROM[95]"] },
    { "name": "HL",      "wave": "=.....x=...........", "data": ["95", "13", 96] },
    { "name": "A",       "wave": "x..........x=......", "data": ["ROM[95]", "13", 96] },
    { "name": "PC",      "wave": "=x=......x=......x=", "data": ["11", "12", "95", "13"] },
    { "name": "NX",      "wave": "=.....x=......x=...", "data": ["12", "95", "13"] },
    { "name": "FLAGLPM1","wave": "0.....1.......0....", "data": ["12", "95", "95"] },
    { "name": "FLAGLPM2","wave": "0........1.......0.", "data": ["12", "95", "95"] },
  
  ],
  "edge": [
    
  ],
  //"head": { text: "[0012]: XOR A, H ; A = 2, H = 4" },
  "head": { text: "INVALID - Loading program memory - INVALID" },
  "config": { "hscale": 1 }
}
 </script>
 This is a very complex instruction and I'm still not sure that I got it right. There have to be
 two flags to remember state while it's executing.
 <br/>
 Actually, the schematic above is <b> wrong </b>. The problem arises when we try to 
 set HL to PC+1 at the same time when setting NX to HL. HL is read and written at the same time.
 <br/>
 
 FLAGLPM1 is set on phase 2 if (FLAGLPM2 == 0 && opcode == LPM). Otherwise it is reset on phase 2.
 <br/>
 FLAGLPM2 is set to the value of FLAGLPM1 on phase 1. This makes it lag one phase behind.
 <br/>
Initially I wanted this instruction to also increment HL pair, since it will already require
 access to incrementer, but HL is needed to remember old PC. This also means this
 instruction trashes HL.
 
 
 
</body>
</html>
